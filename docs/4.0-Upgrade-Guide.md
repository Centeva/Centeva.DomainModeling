# Upgrading to 4.0

This release refactors the obsolete `AsQueryable` method in repositories and the
mechanism for handling domain events.

## Repository

If you are using Centeva's `EfRepository` implementation ensure that it
implements `IReadRepository`:

```csharp
public class EfRepository<TEntity> : RepositoryBase<TEntity>, IReadRepository<TEntity>, IRepository<TEntity> where TEntity : class, IAggregateRoot
{
    public EfRepository(ApplicationDbContext dbContext) : base(dbContext) { }
}
```

The `AsQueryable` method has been moved to its own interface
`IQueryableRepository<T>`.  If your project is using this method (which is not
recommended) then your repository class must implement this interface.  In your
calling code, you should register the implementation of
`IQueryableRepository<T>` in your DI container, and take a dependency upon it in
the places you want to use the method.  

`Program.cs`:

```csharp
services.AddScoped(typeof(IQueryableRepository<>), typeof(EfRepository<>));
```

Calling code:

```csharp
public class GetTodoItemDetailHandler : IRequestHandler<GetTodoItemDetailQuery, TodoItemDetailDto>
{
    private readonly IQueryableRepository<TodoItem> _repository;

    public GetTodoItemDetailHandler(IQueryableRepository<TodoItem> repository)
    {
        _repository = repository;
    }

    public async Task<TodoItemDetailDto> Handle(GetTodoItemDetailQuery request, CancellationToken cancellationToken)
    {
        var todo = await _repository
            .AsQueryable()
            .Where(x => x.Id == request.Id)
            .FirstOrDefaultAsync();

        // more stuff
    }
}
```

## Domain Events

In your classes inheriting from `BaseEntity`, call the `RegisterDomainEvent`
method to add domain events to the entity.  This method is currently marked
`protected` and this can only be called from within derived classes.

Register the event dispatcher with your application's DI container:

```csharp
services.AddScoped<IDomainEventDispatcher, DomainEventDispatcher>();
```

Update your EF Core `DbContext` to use the new dispatcher:

```csharp
public class ApplicationDbContext : DbContext
{
    private readonly IDomainEventDispatcher _domainEventDispatcher;

    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options, IDomainEventDispatcher domainEventDispatcher) : base(options)
    {
        _domainEventDispatcher = domainEventDispatcher;
    }

    public override async Task<int> SaveChangesAsync(CancellationToken cancellationToken = default)
    {
        var result = await base.SaveChangesAsync(cancellationToken).ConfigureAwait(false);

        await DispatchDomainEvents();

        return result;
    }

    private async Task DispatchDomainEvents()
    {
        var entitiesWithEvents = ChangeTracker
            .Entries()
            .Select(e => e.Entity as BaseEntity)
            .Where(e => e is not null && e.DomainEvents.Any())
            .ToList();

        await _domainEventDispatcher.DispatchAndClearEvents(entitiesWithEvents);
    }
}
```
